#!/usr/bin/env groovy

library 'jarvis@v1.2.1'

pipeline {
	agent {
	   node {
		    label 'xcode102'
	    }       
    }
    
    tools {
        nodejs 'NodeJS 9.11.2 & npm 6.4.0 & yarn 1.9.4'
    }

    options {
        gitLabConnection('SC GitLab')
        gitlabBuilds(builds: ['jenkins'])
        buildDiscarder(logRotator(artifactNumToKeepStr: '20', numToKeepStr: '20'))
    }

    post {
        success {		
            archiveArtifacts artifacts: 'blockly/**/*compressed.js'
        }
    }

    stages {        
        stage('Build') {
            steps {
                ansiColor('xterm') {
                    sshagent(['jenkins-ssh-key']) {
                        dir('blockly') {
                            script {
                                sh 'npm install'
                                sh 'npm run prepare'
                                sh 'python build.py'
                            }
                        }
                    }
                }
            }
        }
        stage('Publish') {
            steps {
                ansiColor('xterm') {
                    sshagent(['jenkins-ssh-key']) {
                        script {
                            sh 'echo asdfasdf'                            
                        }
                    }
                }
            }
        }
    }
}